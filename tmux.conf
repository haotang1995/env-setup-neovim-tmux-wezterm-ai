# ~/.tmux.conf
# tmux config with seamless Neovim integration
# Reload: tmux source-file ~/.tmux.conf

# ==========================================================================
# General
# ==========================================================================

# Use 256-color and true color
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Enable OSC 52 clipboard (makes yank work over SSH)
set -g set-clipboard on

# Zero escape delay (critical for Neovim — otherwise Esc feels laggy)
set -sg escape-time 0

# Increase scrollback
set -g history-limit 50000

# Enable mouse (for occasional resizing; you'll still use keyboard)
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable focus events (Neovim uses these for autoread/checktime)
set -g focus-events on

# ==========================================================================
# Prefix key
# ==========================================================================

# Keep Ctrl+B as prefix (standard, works everywhere)
# If you prefer Ctrl+A: uncomment below
# set -g prefix C-a
# unbind C-b
# bind C-a send-prefix

# ==========================================================================
# Pane splitting (intuitive keys)
# ==========================================================================

# | for vertical split, - for horizontal split (in current directory)
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"    # backslash too (no shift needed)
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New window in current directory
bind c new-window -c "#{pane_current_path}"

# ==========================================================================
# Neovim-aware pane navigation (Ctrl+hjkl)
# ==========================================================================

# Smart pane switching: detects if Neovim is running and sends keys to it,
# otherwise switches tmux panes. Works with vim-tmux-navigator plugin.
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
bind-key -n 'C-\' if-shell "$is_vim" 'send-keys C-\\'  'select-pane -l'

# Also bind in copy-mode (so navigation works while scrolling)
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# Backup: prefix + hjkl for pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# ==========================================================================
# Pane resizing (prefix + arrow keys, or prefix + HJKL)
# ==========================================================================

bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ==========================================================================
# Vi copy mode
# ==========================================================================

setw -g mode-keys vi

# Enter copy mode with prefix + [
# v to start selection, y to yank, q to cancel
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle  # block selection

# ==========================================================================
# Session management
# ==========================================================================

# Quick session switching
bind s choose-tree -sZ               # session picker (tmux built-in)
bind S command-prompt -p "new session:" "new-session -s '%%'"

# Switch to last session
bind L switch-client -l

# ==========================================================================
# Window management
# ==========================================================================

# Quick window switching
bind -r n next-window
bind -r p previous-window

# Swap windows
bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

# Zoom pane (toggle fullscreen for current pane)
# Default: prefix + z (already bound)

# ==========================================================================
# Status bar
# ==========================================================================

set -g status-position top
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# Left: session name
set -g status-left "#[fg=#89b4fa,bold] #S  "
set -g status-left-length 30

# Right: date/time
set -g status-right "#[fg=#a6adc8] %H:%M  %d-%b "

# Window tabs
set -g window-status-format "#[fg=#6c7086] #I:#W "
set -g window-status-current-format "#[fg=#89b4fa,bold] #I:#W "

# ==========================================================================
# Quality of life
# ==========================================================================

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Clear screen (since C-l is taken by navigation)
bind C-l send-keys 'C-l'

# Kill pane without confirmation
bind x kill-pane

# Synchronize panes (type in all panes simultaneously — useful for cluster ops)
bind e setw synchronize-panes

# Allow iTerm2 image protocol to pass through tmux
set -g allow-passthrough on
set -ga terminal-overrides ',xterm*:smcup@:rmcup@'

# ==========================================================================
# AI Agent Windows
# ==========================================================================

# Automatically open AI agent windows when a new session is created
set-hook -g session-created "run-shell 'tmux new-window -d -t 2 -n gemini gemini && tmux new-window -d -t 3 -n claude claude && tmux new-window -d -t 4 -n codex codex && tmux select-window -t 1'"
